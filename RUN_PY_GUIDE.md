# run.py - 실시간 이미지 캡셔닝 및 양자화 테스트

## 📋 기능 개요

`run.py`는 실시간 카메라 입력을 받아 이미지 캡셔닝을 수행하고, 여러 양자화 옵션을 비교할 수 있는 대화형 애플리케이션입니다.

---

## ✨ 주요 기능

### 1️⃣ **모델 선택**

```
=== 사용할 모델 선택 ===
1. Original Model ✅ 사용 가능
2. Pruned Model (Struct 30% + Mag 10%) ✅ 사용 가능

모델을 선택하세요 (1-2): 1
```

### 2️⃣ **양자화 옵션 선택**

```
=== 양자화 옵션 선택 ===
1. FP32 (원본) ✅
2. FP16 (Half Precision) ✅
3. INT8 (Dynamic Quantization) ✅

양자화 옵션을 선택하세요 (1-3): 2
```

### 3️⃣ **성능 지표 실시간 모니터링**

```
모델: Original Model + FP16
FPS: 833.3  Latency: 1.2ms
CPU: 245MB  GPU: 512MB
```

### 4️⃣ **실시간 캡션 생성 및 음성 출력**

- 'S': 현재 프레임에서 캡션 생성
- 'R': 마지막 캡션 다시 듣기
- 'P': 성능 통계 출력
- 'M': 모델/양자화 옵션 변경
- 'Q': 종료

---

## 🚀 실행 방법

### 기본 실행

```bash
python3 scripts/run.py
```

### 모델과 양자화 선택 순서

1. **모델 선택**: Original 또는 Pruned
2. **양자화 선택**: FP32 / FP16 / INT8
3. **카메라 준비**: 웹캠 또는 built-in 카메라
4. **키 입력으로 제어**

---

## 📊 양자화 옵션 비교

| 옵션     | 모델 크기 | 추론 속도 | 정확도 | 호환성  |
| :------- | :-------: | :-------: | :----: | :-----: |
| **FP32** |   100%    |   100%    |  100%  | ✅ 완벽 |
| **FP16** |    50%    |   110%    |  99%   | ✅ 좋음 |
| **INT8** |    25%    |   130%    |  95%   | ⚠️ 제한 |

### FP16 (Half Precision)

- **메모리 사용**: 50% 감소
- **추론 시간**: 약간 빠름
- **정확도 손실**: 거의 없음 (1%)
- **권장**: 대부분의 경우

### INT8 (Dynamic Quantization)

- **메모리 사용**: 75% 감소 (선택적 레이어)
- **추론 시간**: 빠름
- **정확도 손실**: 5-10%
- **주의**: 모든 레이어에 적용되지 않을 수 있음

---

## 📈 성능 모니터링 (JTOPS)

'P' 키를 눌러 상세 통계 확인:

```
=== 성능 통계 (JTOPS 스타일) ===
⏱️  추론 시간 (Latency):
    • 평균: 1.20 ms
    • 중앙값: 1.15 ms
    • 최소/최대: 1.05 / 1.35 ms
    • 표준편차: 0.10 ms

🎬 처리 속도 (Throughput):
    • FPS: 833.3 frame/sec
    • 1프레임 처리: 1.20 ms

💾 메모리 사용량:
    • CPU: 245.5 MB
    • GPU: 512.3 MB

📊 누적 통계:
    • 총 추론 횟수: 15회
```

---

## 🎯 모델 비교 테스트 시나리오

### 1. Original Model 벤치마크

```
선택: 1 (Original) → 1 (FP32)
결과: 기본 성능 측정 (baseline)
```

### 2. Pruned Model 벤치마크

```
선택: 2 (Pruned) → 1 (FP32)
결과: 프루닝 효과 측정
```

### 3. 양자화 효과 비교

```
선택: 1 (Original) → 2 (FP16)
선택: 1 (Original) → 3 (INT8)
결과: 양자화 영향 분석
```

### 4. 최적 조합 찾기

```
선택: 2 (Pruned) → 2 (FP16)
선택: 2 (Pruned) → 3 (INT8)
결과: 크기-성능 트레이드오프 최적화
```

---

## 🔧 구현 상세

### 모델 로드 (`load_model`)

- Original: `models/lightweight_captioning_model.pth`
- Pruned: `pruning_results/Pruning_epoch_1_checkpoint.pt`
- 자동 크기 감지 (decoder_dim, attention_dim)

### 양자화 적용 (`apply_quantization`)

- **FP16**: `model.half()` - PyTorch 기본 기능
- **INT8**: `apply_dynamic_quantization()` - fbgemm/qnnpack 엔진

### 성능 모니터 (`PerformanceMonitor`)

- 추론 시간 기록 (최근 30개 평균)
- CPU/GPU 메모리 사용량 추적
- 실시간 FPS 계산

---

## ⚠️ 주의사항

1. **카메라 접근 권한**: 필요시 시스템 설정에서 카메라 권한 허용
2. **음성 출력**: pygame mixer 초기화 필요
3. **양자화 호환성**: INT8은 CPU 환경에서만 지원
4. **메모리**: 대용량 모델은 GPU 필수 권장

---

## 📝 키 입력 상세

| 키  | 기능             | 용도           |
| :-- | :--------------- | :------------- |
| `S` | 캡션 생성        | 현재 화면 분석 |
| `R` | 마지막 캡션 재생 | 음성 확인      |
| `P` | 성능 통계 출력   | 상세 벤치마크  |
| `M` | 모델/양자화 변경 | 실시간 비교    |
| `Q` | 종료             | 프로그램 종료  |

---

## 🎯 권장 사용 시나리오

### 실시간 테스트

```bash
python3 scripts/run.py
# 1 (Original) → 2 (FP16) 선택
# 실시간 음성 피드백과 함께 캡션 생성
```

### 벤치마크 비교

```bash
python3 scripts/run.py
# 여러 모델/양자화 조합 테스트
# 'P' 키로 성능 통계 확인
# 최적 조합 도출
```

### 임베디드 환경 검증

```bash
python3 scripts/run.py
# 2 (Pruned) → 2 (FP16) 선택
# 임베디드 환경 성능 시뮬레이션
# 메모리/속도 트레이드오프 확인
```

---

## ✅ 수정 사항

### v2.0 - 양자화 통합

- ✅ FP16 양자화 지원 추가
- ✅ INT8 양자화 지원 추가
- ✅ 실시간 모델 변경 기능
- ✅ 양자화 옵션 선택 인터페이스
- ✅ 성능 모니터링 개선

---

**마지막 업데이트**: 2024년 12월 7일  
**상태**: ✅ 완성  
**호환성**: Python 3.6+ (모든 f-string 제거)
